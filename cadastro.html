<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel - Multi Lojas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:#fff;
  padding:20px;
}
h2,h3{margin-top:0}
input{
  padding:8px;
  margin:5px 0;
  width:100%;
  max-width:300px;
  border-radius:6px;
  border:none;
}
button{
  padding:8px 15px;
  margin:5px 0;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.primary{background:#22c55e;color:#fff;}
.logout{background:#ef4444;color:#fff;}
.card{
  background:#1e293b;
  padding:15px;
  margin-top:10px;
  border-radius:8px;
}
</style>
</head>
<body>

<h2>Painel do Lojista</h2>
<button class="logout" onclick="logout()">Sair</button>

<hr>

<div id="areaLoja">
  <h3>Criar Loja</h3>
  <input id="nomeLoja" placeholder="Nome da loja">
  <input id="slugLoja" placeholder="Slug (ex: farias)">
  <button class="primary" onclick="criarLoja()">Criar Loja</button>
</div>

<hr>

<div id="areaProdutos" style="display:none;">
  <h3>Cadastrar Produto</h3>
  <input id="nomeProduto" placeholder="Nome do produto">
  <input id="marcaProduto" placeholder="Marca">
  <input id="precoProduto" placeholder="Preço">
  <input id="estoqueProduto" placeholder="Estoque">
  <button class="primary" onclick="cadastrarProduto()">Cadastrar</button>

  <h3>Meus Produtos</h3>
  <div id="listaProdutos"></div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://bzgvbghxmebdjqnlakbj.supabase.co",
  "sb_publishable_IyvZNwtgkvECR0QVlYbhzw_zPL1TMJv"
);

let lojaAtual = null;
let usuarioAtual = null;

async function iniciar(){

  const { data:{user} } = await supabase.auth.getUser();

  if(!user){
    location.href="index.html";
    return;
  }

  usuarioAtual = user;

  const { data: loja } = await supabase
    .from("lojas")
    .select("*")
    .eq("usuario_id", user.id)
    .single();

  if(loja){
    lojaAtual = loja;
    document.getElementById("areaLoja").style.display="none";
    document.getElementById("areaProdutos").style.display="block";
    carregarProdutos();
  }
}

async function criarLoja(){

  if(!nomeLoja.value || !slugLoja.value){
    alert("Preencha os campos!");
    return;
  }

  const { data, error } = await supabase
    .from("lojas")
    .insert({
      nome: nomeLoja.value,
      slug: slugLoja.value,
      usuario_id: usuarioAtual.id
    })
    .select()
    .single();

  if(error){
    alert("Erro ao criar loja");
    console.log(error);
    return;
  }

  lojaAtual = data;
  alert("Loja criada com sucesso!");

  document.getElementById("areaLoja").style.display="none";
  document.getElementById("areaProdutos").style.display="block";
}

async function cadastrarProduto(){

  if(!lojaAtual){
    alert("Crie uma loja primeiro");
    return;
  }

  const { error } = await supabase.from("produtos").insert({
    loja_id: lojaAtual.id,
    nome: nomeProduto.value,
    marca: marcaProduto.value,
    preco: precoProduto.value,
    estoque: estoqueProduto.value
  });

  if(error){
    alert("Erro ao cadastrar produto");
    console.log(error);
    return;
  }

  nomeProduto.value="";
  marcaProduto.value="";
  precoProduto.value="";
  estoqueProduto.value="";

  carregarProdutos();
}

async function carregarProdutos(){

  const { data } = await supabase
    .from("produtos")
    .select("*")
    .eq("loja_id", lojaAtual.id);

  const lista = document.getElementById("listaProdutos");
  lista.innerHTML="";

  data.forEach(p=>{
    lista.innerHTML += `
      <div class="card">
        <strong>${p.nome}</strong><br>
        Marca: ${p.marca}<br>
        Preço: R$ ${p.preco}<br>
        Estoque: ${p.estoque}
      </div>
    `;
  });
}

async function logout(){
  await supabase.auth.signOut();
  location.href="index.html";
}

iniciar();
</script>

</body>
</html>
